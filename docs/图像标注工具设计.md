# JLab 图像标注工具需求与设计说明

## 1. 目标与范围
- 面向 2D 目标检测与属性分类的图像标注工具。
- 支持普通目标多边形与 ROI，多边形为核心形状。
- 操作效率优先（左键主操作、右键辅助），跨平台（Windows/Linux）。

## 2. 数据与目录结构

### 2.1 项目结构
```
label_root/
├── meta.yaml    # 项目元信息（类别、属性、显示参数等）
├── images/      # 图像文件
└── labels/      # 标注文件（与图像同名）
```

### 2.2 标注文件（YAML）
- 坐标使用归一化 [0, 1]。
- `rois` 为多边形数组，可包含多个 ROI，每个 ROI 为点列表。
- `objects` 为目标列表，包含类别与属性。

示例：
```yaml
version: '2.0'
created_at: '2025-01-01T00:00:00+08:00'
last_modified: '2025-01-01T00:00:10+08:00'

rois:
  - - x: 0.1
      y: 0.1
    - x: 0.9
      y: 0.1
    - x: 0.9
      y: 0.9

objects:
  - id: 0
    category: 0
    confidence: 1.0
    polygon:
      - x: 0.2
        y: 0.3
      - x: 0.4
        y: 0.3
      - x: 0.4
        y: 0.5
    properties: {}
```

### 2.3 ROI 与对象
- ROI 与普通多边形使用相同的绘制与编辑交互。
- ROI 无属性字段与属性编辑界面。

## 3. 界面结构
- 菜单栏：文件、编辑、视图、导航、帮助。
- 文件菜单：打开/保存、自动保存开关、导入/导出、选项对话框、关闭项目。
- 工具栏：模式切换、绘制目标、缩放选择、左/右侧栏开关。
- 左侧栏：对象列表与 ROI 列表（对象为 `#ID - 类别`，ROI 为 `#序号 - ROI`），标题显示数量，宽度可拖拽调整。
- 右侧栏：属性编辑，只有编辑模式可写，其它模式显示只读提示，宽度可拖拽调整。
- 中央画布：显示图像与标注。
- 状态栏：进度、文件名、尺寸、自动保存、未保存提示、像素坐标、功能提示（含快捷键）。

### 3.1 选项对话框
通过**文件菜单 → 选项**打开，包含两个标签页：

**常规标签：**
- 语言选择（中文/English）
- 外观设置：
  - 字体大小 (10-30)
  - 界面缩放 (0.5x-2.0x)
  - 主题（深色/浅色/跟随系统）
  - 显示滚动条
- 项目设置：自动保存开关
- 恢复默认值按钮

**快捷键标签：**
- 全局搜索框
- 类别筛选（全部/文件/编辑/模式/导航/视图/工具）
- 快捷键编辑与冲突检测
- 重置默认值

### 3.2 设置持久化
用户配置保存在 `~/.config/jlab/`：
- `ui_settings.json` - 字体、缩放、滚动条等外观设置
- `theme.json` - 主题设置
- `auto_save.json` - 自动保存设置
- `shortcuts.yaml` - 快捷键配置

## 4. 模式与交互规则

### 4.1 浏览模式（只读）
- 左键选中对象/ROI，点击空白区域取消选中。
- 禁止任何修改与移动。

### 4.2 绘制模式
- 左键添加顶点；若无正在绘制的多边形则新建。
- 右键删除最后一个点。
- `Space`/菜单“完成目标”：完成绘制并保持在绘制模式。
- 双击：完成绘制并自动切换到编辑模式。
- 双击已有对象可直接进入编辑模式。
- 不用于选中已有对象，仅显示当前绘制多边形顶点（不可拖动）。
- 新建目标使用“默认类别”（菜单/工具栏可设置；ROI 不适用）。

### 4.3 编辑模式
- 左键选中对象/ROI；多个目标重叠时，选中面积最小的目标。
- 点击空白区域取消选中。
- 仅选中目标显示顶点圆圈。
- 顶点与边的选中半径扩大；若同时命中顶点与边，优先选中边。
- 可拖动多边形整体移动。
- 拖动边中段（0.1~0.9）插入顶点并随拖动移动。
- 右键点击顶点删除。
- 仅允许编辑当前选中目标。

## 5. 快捷键与基础操作（默认）
- 导航：`A/D` 上一张/下一张，`W/S` 前进/后退 10 张。
- 保存/打开/退出：`Ctrl+S` / `Ctrl+O` / `Ctrl+Q`。
- 模式切换：`Shift+1/2/3`（浏览/绘制/编辑）。
- 完成绘制：`Space`/双击（绘制模式）。
- 删除：`Del`。
- 取消：`Esc`。
- 复制/粘贴：`Ctrl+C`/`Ctrl+V`（编辑模式；无选中则复制全部目标与 ROI，粘贴追加并重新分配 ID）。
- 画布：滚轮缩放，`Ctrl+拖动`/中键平移，`F` 适应画布。
- 形状：`R` 变成矩形，`B` 自交修正（编辑模式）。
- 移动对象：`方向键`（1px）/`Shift+方向键`（10px）（编辑模式）。
- 缩放对象：`+/-`（编辑模式）。
- 快捷键支持自定义配置（`~/.config/jlab/shortcuts.yaml`），重置缩放无默认快捷键。

### 快捷键分类
- **文件**：打开项目、保存、关闭项目、退出
- **编辑**：复制、粘贴、删除、取消选中、完成绘制
- **模式**：切换到浏览/绘制/编辑模式
- **导航**：上一张/下一张图像、前进/后退 10 张
- **视图**：适应画布、重置缩放、缩放级别、切换侧边栏
- **工具**：移动对象（4方向）、缩放对象、变成矩形、自交修正
- **其他**：切换自动保存、取消操作

## 6. 其他功能要求
- 图像加载与渲染：支持 JPG/PNG。
- 自动保存：切换图像时自动保存（文件菜单可开关）。
- 导入/导出：支持 YOLO/VOC/COCO/LabelMe；导入合并并检查图片重名。
- 进度记忆：重新打开项目恢复上次进度。
- 错误处理：加载失败与保存失败提示原因。
- 性能：大尺寸图像操作无明显卡顿。
